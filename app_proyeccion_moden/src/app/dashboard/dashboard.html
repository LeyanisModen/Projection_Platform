<div class="dashboard-container">
    <!-- HEADER -->
    <header class="dashboard-header">
        <img src="assets/logo-moden.jpg" alt="MOD:EN Logo" class="header-logo">
        <span class="subtitle">Sistema de Gesti√≥n de Proyecci√≥n</span>
    </header>

    <main class="dashboard-main">
        <!-- SIDEBAR: PROJECTS PANEL (Collapsible) -->
        <aside class="projects-panel" [class.collapsed]="panelState === 'collapsed'">
            <!-- Sidebar Header -->
            <div class="panel-header">
                <button class="btn-menu" (click)="togglePanel()">‚ò∞</button>
                <div class="header-title" *ngIf="panelState === 'expanded'">
                    @if (navLevel !== 'projects') {
                    <button class="btn-back" (click)="navigateBack()">‚Üê</button>
                    }
                    <h2>{{ getHeaderTitle() }}</h2>
                </div>
            </div>

            <!-- Sidebar Content -->
            <div class="panel-content" *ngIf="panelState === 'expanded'">
                @if (navLevel === 'projects') {
                <ul class="nav-list">
                    @if (loadingProyectos) { <div class="loading">Cargando...</div> }
                    @for (proyecto of proyectos; track proyecto.id) {
                    <li class="nav-item" [class.selected]="selectedProyecto?.id === proyecto.id"
                        (click)="selectProyecto(proyecto)">
                        <span class="nav-icon">üìÅ</span>
                        <span class="nav-text">{{ proyecto.nombre }}</span>
                        <span class="nav-arrow">‚Ä∫</span>
                    </li>
                    }
                </ul>
                }

                @if (navLevel === 'plants') {
                <ul class="nav-list">
                    @if (loadingPlantas) { <div class="loading">Cargando...</div> }
                    @for (planta of plantas; track planta.id) {
                    <li class="nav-item" [class.selected]="selectedPlanta?.id === planta.id"
                        (click)="selectPlanta(planta)">
                        <span class="nav-icon">üè≠</span>
                        <span class="nav-text">{{ planta.nombre }}</span>
                        <span class="nav-arrow">‚Ä∫</span>
                    </li>
                    }
                </ul>
                }

                @if (navLevel === 'modules') {
                <ul class="nav-list">
                    @if (loadingModulos) { <div class="loading">Cargando...</div> }
                    @for (modulo of modulos; track modulo.id) {
                    <li class="nav-item" [class.selected]="selectedModulo?.id === modulo.id"
                        (click)="toggleModulo(modulo)">
                        <span class="nav-icon">üì¶</span>
                        <div class="nav-item-content">
                            <span class="nav-text">{{ modulo.nombre }}</span>
                            <div class="nav-phases">
                                <span class="phase-dot" [class.done]="modulo.inferior_hecho" title="Inferior"></span>
                                <span class="phase-dot" [class.done]="modulo.superior_hecho" title="Superior"></span>
                            </div>
                        </div>
                    </li>
                    }
                </ul>
                }
            </div>
        </aside>

        <!-- WORKSPACE: IMAGES & MESAS -->
        <section class="dashboard-workspace">

            <!-- SOURCE ZONE: IMAGES PANEL (Visible when a module is selected) -->
            <div class="images-panel" *ngIf="selectedModulo">
                <div class="panel-header-workspace">
                    <h3>Im√°genes: {{ selectedModulo.nombre }}</h3>
                    <span class="subtitle">{{ selectedProyecto?.nombre }} / {{ selectedPlanta?.nombre }}</span>
                </div>

                <div class="images-scroll-container">
                    @if (loadingImagenes) {
                    <div class="loading">Cargando im√°genes...</div>
                    } @else if (getModuloImagenes(selectedModulo.id).length === 0) {
                    <div class="empty-state">Sin im√°genes</div>
                    } @else {
                    @for (imagen of getModuloImagenes(selectedModulo.id); track imagen.id) {
                    <div class="imagen-card" draggable="true"
                        (dragstart)="onImageDragStart($event, imagen, selectedModulo!)" (dragend)="onDragEnd($event)"
                        [class.inferior]="imagen.fase === 'INFERIOR'" [class.superior]="imagen.fase === 'SUPERIOR'">
                        <span class="imagen-fase">{{ imagen.fase === 'INFERIOR' ? '‚ñº' : '‚ñ≤' }}</span>
                        <span class="imagen-name">{{ imagen.nombre }}</span>
                        <span class="imagen-drag-hint">‚ãÆ‚ãÆ</span>
                    </div>
                    }
                    }
                </div>
                <!-- Drag hint if active -->
                <div class="workspace-hint">
                    Arrestra las im√°genes a una mesa abajo ‚Üì
                </div>
            </div>

            <!-- INLINE EMPTY STATE if no module selected -->
            @if (!selectedModulo) {
            <div class="workspace-hint-empty">
                <span class="icon">üìÇ</span> Selecciona un m√≥dulo en el panel izquierdo para ver sus im√°genes.
            </div>
            }

            <!-- TARGET ZONE: MESAS GRID -->
            <div class="mesas-section">
                <div class="section-header">
                    <h2>Mesas de Trabajo</h2>
                </div>
                <div class="mesas-grid">
                    @if (loadingMesas) {
                    <div class="loading">Cargando mesas...</div>
                    } @else {
                    @for (mesa of mesas; track trackByMesa($index, mesa)) {
                    <div class="mesa-card" [class.locked]="mesa.locked" [class.blackout]="mesa.blackout">
                        <div class="mesa-header">
                            <h3>{{ mesa.nombre }}</h3>
                            @if (mesa.locked) { <span class="mesa-badge locked">üîí</span> }
                            @if (mesa.blackout) { <span class="mesa-badge blackout">‚¨õ</span> }
                        </div>

                        <!-- Drop Zone -->
                        <div class="drop-zone" (dragover)="onDragOver($event, mesa)" (dragleave)="onDragLeave($event)"
                            (drop)="onImageDrop($event, mesa)" [class.drag-over]="dragOverMesa === mesa.id">
                            <span class="drop-icon">üì•</span>
                            <span class="drop-text">Soltar imagen</span>
                        </div>

                        <!-- Queue -->
                        <div class="mesa-queue">
                            @for (item of getMesaQueueItems(mesa.id); track trackByItem($index, item)) {
                            <div class="queue-item" [class]="getItemStatusClass(item.status)">
                                <div class="queue-item-info">
                                    <span class="queue-item-fase" [class.inferior]="item.fase === 'INFERIOR'"
                                        [class.superior]="item.fase === 'SUPERIOR'">
                                        {{ item.fase === 'INFERIOR' ? '‚ñº' : '‚ñ≤' }}
                                    </span>
                                    <span class="queue-item-nombre">{{ item.modulo_nombre }}</span>
                                    <span class="queue-item-status">{{ item.status }}</span>
                                </div>
                                <div class="queue-item-actions">
                                    @if (item.status === 'EN_COLA') {
                                    <button class="btn-action btn-mostrar" (click)="mostrarItem(item)"
                                        title="Mostrar">‚ñ∂</button>
                                    }
                                    @if (item.status === 'MOSTRANDO') {
                                    <button class="btn-action btn-hecho" (click)="marcarHecho(item)"
                                        title="Marcar hecho">‚úì</button>
                                    }
                                    @if (item.status !== 'HECHO') {
                                    <button class="btn-action btn-eliminar" (click)="eliminarItem(item)"
                                        title="Eliminar">‚úï</button>
                                    }
                                </div>
                            </div>
                            }
                        </div>
                    </div>
                    }
                    }
                </div>
            </div>

        </section>
    </main>
</div>