<div class="dashboard-container">
    <!-- HEADER -->
    <header class="dashboard-header">
        <h1>MOD:EN</h1>
        <span class="subtitle">Sistema de Gesti√≥n de Proyecci√≥n</span>
    </header>

    <!-- 3-SECTION LAYOUT -->
    <main class="dashboard-main">
        <!-- SECTION 1: PROYECTOS -->
        <section class="section section-proyectos">
            <div class="section-header">
                <h2>Proyectos</h2>
            </div>
            <div class="section-content">
                @if (loadingProyectos) {
                <div class="loading">Cargando proyectos...</div>
                } @else if (proyectos.length === 0) {
                <div class="empty-state">No hay proyectos</div>
                } @else {
                <ul class="proyecto-list" cdkDropList (cdkDropListDropped)="onProjectDrop($event)">
                    @for (proyecto of proyectos; track trackByProyecto($index, proyecto)) {
                    <li class="proyecto-item" cdkDrag [class.selected]="selectedProyecto?.id === proyecto.id"
                        (click)="selectProyecto(proyecto)">
                        <span class="proyecto-nombre">{{ proyecto.nombre }}</span>
                        <span class="drag-handle" cdkDragHandle>‚ò∞</span>
                    </li>
                    }
                </ul>
                }
            </div>
        </section>

        <!-- SECTION 2: MODULOS (con im√°genes) -->
        <section class="section section-modulos">
            <div class="section-header">
                <h2>M√≥dulos</h2>
                @if (selectedProyecto) {
                <span class="section-subtitle">{{ selectedProyecto.nombre }}</span>
                }
            </div>
            <div class="section-content">
                @if (!selectedProyecto) {
                <div class="empty-state">Selecciona un proyecto</div>
                } @else if (loadingModulos) {
                <div class="loading">Cargando m√≥dulos...</div>
                } @else if (modulos.length === 0) {
                <div class="empty-state">No hay m√≥dulos en este proyecto</div>
                } @else {
                <ul class="modulo-list">
                    @for (modulo of modulos; track trackByModulo($index, modulo)) {
                    <li class="modulo-item" [class]="getModuloEstadoClass(modulo)"
                        [class.expanded]="expandedModulo === modulo.id" (click)="toggleModulo(modulo)">
                        <div class="modulo-header">
                            <div class="modulo-info">
                                <span class="modulo-nombre">{{ modulo.nombre }}</span>
                                <span class="modulo-planta">{{ modulo.planta }}</span>
                            </div>
                            <div class="modulo-phases">
                                <span class="phase" [class.done]="modulo.inferior_hecho" title="Inferior">‚ñº</span>
                                <span class="phase" [class.done]="modulo.superior_hecho" title="Superior">‚ñ≤</span>
                            </div>
                            <span class="modulo-estado">{{ modulo.estado }}</span>
                            <span class="modulo-expand">{{ expandedModulo === modulo.id ? '‚ñæ' : '‚ñ∏' }}</span>
                        </div>

                        <!-- Im√°genes del m√≥dulo (expandible) -->
                        @if (expandedModulo === modulo.id) {
                        <div class="modulo-imagenes">
                            @if (loadingImagenes) {
                            <div class="loading-small">Cargando im√°genes...</div>
                            } @else {
                            @for (imagen of getModuloImagenes(modulo.id); track imagen.id) {
                            <div class="imagen-item" draggable="true" (mousedown)="$event.stopPropagation()"
                                (dragstart)="onImageDragStart($event, imagen, modulo)" (dragend)="onDragEnd($event)"
                                [class.inferior]="imagen.fase === 'INFERIOR'"
                                [class.superior]="imagen.fase === 'SUPERIOR'">
                                <span class="imagen-fase">{{ imagen.fase === 'INFERIOR' ? '‚ñº' : '‚ñ≤' }}</span>
                                <span class="imagen-label">{{ imagen.nombre }}</span>
                                <span class="imagen-drag-hint">‚ò∞</span>
                            </div>
                            }
                            @if (getModuloImagenes(modulo.id).length === 0) {
                            <div class="no-imagenes">Sin im√°genes</div>
                            }
                            }
                        </div>
                        }
                    </li>
                    }
                </ul>
                <div class="drag-hint">
                    ‚Üî Expande un m√≥dulo y arrastra sus im√°genes a una mesa
                </div>
                }
            </div>
        </section>

        <!-- SECTION 3: MESAS (drop zone √∫nico) -->
        <section class="section section-mesas">
            <div class="section-header">
                <h2>Mesas de Trabajo</h2>
            </div>
            <div class="section-content">
                @if (loadingMesas) {
                <div class="loading">Cargando mesas...</div>
                } @else if (mesas.length === 0) {
                <div class="empty-state">No hay mesas configuradas</div>
                } @else {
                <div class="mesas-grid">
                    @for (mesa of mesas; track trackByMesa($index, mesa)) {
                    <div class="mesa-card" [class.locked]="mesa.locked" [class.blackout]="mesa.blackout">
                        <div class="mesa-header">
                            <h3>{{ mesa.nombre }}</h3>
                            @if (mesa.locked) {
                            <span class="mesa-badge locked">üîí</span>
                            }
                            @if (mesa.blackout) {
                            <span class="mesa-badge blackout">‚¨õ</span>
                            }
                        </div>

                        <!-- Single drop zone for any image -->
                        <div class="drop-zone" (dragover)="onDragOver($event, mesa)" (dragleave)="onDragLeave($event)"
                            (drop)="onImageDrop($event, mesa)" [class.drag-over]="dragOverMesa === mesa.id">
                            <span class="drop-icon">üì•</span>
                            <span class="drop-text">Soltar imagen aqu√≠</span>
                        </div>

                        <!-- Queue items -->
                        <div class="mesa-queue">
                            @for (item of getMesaQueueItems(mesa.id); track trackByItem($index, item)) {
                            <div class="queue-item" [class]="getItemStatusClass(item.status)">
                                <div class="queue-item-info">
                                    <span class="queue-item-fase" [class.inferior]="item.fase === 'INFERIOR'"
                                        [class.superior]="item.fase === 'SUPERIOR'">
                                        {{ item.fase === 'INFERIOR' ? '‚ñº' : '‚ñ≤' }}
                                    </span>
                                    <span class="queue-item-nombre">{{ item.modulo_nombre }}</span>
                                    <span class="queue-item-status">{{ item.status }}</span>
                                </div>
                                <div class="queue-item-actions">
                                    @if (item.status === 'EN_COLA') {
                                    <button class="btn-action btn-mostrar" (click)="mostrarItem(item)"
                                        title="Mostrar">‚ñ∂</button>
                                    }
                                    @if (item.status === 'MOSTRANDO') {
                                    <button class="btn-action btn-hecho" (click)="marcarHecho(item)"
                                        title="Marcar hecho">‚úì</button>
                                    }
                                    @if (item.status !== 'HECHO') {
                                    <button class="btn-action btn-eliminar" (click)="eliminarItem(item)"
                                        title="Eliminar">‚úï</button>
                                    }
                                </div>
                            </div>
                            }
                            @if (getMesaQueueItems(mesa.id).length === 0) {
                            <div class="queue-empty">Sin trabajos asignados</div>
                            }
                        </div>
                    </div>
                    }
                </div>
                }
            </div>
        </section>
    </main>
</div>