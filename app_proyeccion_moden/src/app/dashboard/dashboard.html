<div class="dashboard-container">
    <!-- HEADER -->
    <header class="dashboard-header">
        <img src="assets/logo-moden.jpg" alt="MOD:EN Logo" class="header-logo">
        <span class="subtitle">Sistema de Gesti√≥n de Proyecci√≥n</span>
        <div class="header-right">
            <span class="user-display">üë§ {{ username }}</span>
            <button class="btn-logout" (click)="logout()" title="Cerrar Sesi√≥n">‚èª</button>
        </div>
    </header>

    <main class="dashboard-main">
        <!-- SIDEBAR: PROJECTS PANEL (Collapsible) -->
        <aside class="projects-panel" [class.collapsed]="panelState === 'collapsed'">
            <!-- Sidebar Header -->
            <div class="panel-header">
                <button class="btn-menu" (click)="togglePanel()">‚ò∞</button>
                <div class="header-title" *ngIf="panelState === 'expanded'">
                    @if (navLevel !== 'projects') {
                    <button class="btn-back" (click)="navigateBack()">‚Üê</button>
                    }
                    <div class="header-text-group">
                        @if (navLevel === 'projects') {
                        <h2>Proyectos</h2>
                        <small class="text-muted">Lista de Proyectos</small>
                        } @else if (navLevel === 'plants') {
                        <h2>{{ selectedProyecto?.nombre }}</h2>
                        <small class="text-muted">Plantas</small>
                        } @else if (navLevel === 'modules') {
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div>
                                <h2>{{ selectedProyecto?.nombre }}</h2>
                                <small class="text-muted">{{ selectedPlanta?.nombre }}</small>
                            </div>
                            <div class="planta-actions" *ngIf="selectedPlanta && selectedPlanta.plano_imagen">
                                <button class="btn-icon-header" (click)="verPlano(selectedPlanta)"
                                    title="Ver Plano de Planta">
                                    <!-- Custom 'Flat Floorplan' Icon -->
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <!-- Outer Frame -->
                                        <rect x="4" y="4" width="16" height="16" rx="2" stroke="currentColor"
                                            stroke-width="2" />
                                        <!-- Internal Walls/Divisions -->
                                        <path d="M10 4V12H16" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" />
                                        <path d="M4 14H10" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" />
                                        <path d="M14 12V20" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" />
                                        <!-- Door indicator (optional detail) -->
                                        <path d="M18 12V10" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        }
                    </div>
                </div>
            </div>


            <!-- Sidebar Content -->
            <div class="panel-content" *ngIf="panelState === 'expanded'">
                @if (navLevel === 'projects') {
                <ul class="nav-list">
                    @if (loadingProyectos) { <div class="loading">Cargando...</div> }
                    @for (proyecto of proyectos; track proyecto.id) {
                    <li class="nav-item" [class.selected]="selectedProyecto?.id === proyecto.id"
                        (click)="selectProyecto(proyecto)">
                        <span class="nav-icon">üìÅ</span>
                        <span class="nav-text">{{ proyecto.nombre }}</span>
                        <span class="nav-arrow">‚Ä∫</span>
                    </li>
                    }
                </ul>
                }

                @if (navLevel === 'plants') {
                <ul class="nav-list">
                    @if (loadingPlantas) { <div class="loading">Cargando...</div> }
                    @for (planta of plantas; track planta.id) {
                    <li class="nav-item" [class.selected]="selectedPlanta?.id === planta.id"
                        (click)="selectPlanta(planta)">
                        <span class="nav-icon">üè≠</span>
                        <span class="nav-text">{{ planta.nombre }}</span>

                        <!-- Actions for Plant -->
                        <div class="nav-item-actions">
                            <a *ngIf="planta.fichero_corte" [href]="planta.fichero_corte" target="_blank"
                                class="btn-icon-action pdf" title="Descargar Planilla"
                                (click)="$event.stopPropagation()">
                                üìÑ
                            </a>
                        </div>

                        <span class="nav-arrow">‚Ä∫</span>
                    </li>
                    }
                </ul>
                }

                @if (navLevel === 'modules') {
                <ul class="nav-list">
                    @if (loadingModulos) { <div class="loading">Cargando...</div> }
                    @for (modulo of modulos; track modulo.id) {
                    <li class="nav-item" [class.selected]="selectedModulo?.id === modulo.id"
                        [class.disabled]="isModuloComplete(modulo)"
                        (click)="!isModuloComplete(modulo) && toggleModulo(modulo)">
                        <span class="nav-icon">üì¶</span>

                        <div class="nav-item-content">
                            <span class="nav-text">{{ modulo.nombre }}</span>
                            <div class="nav-phases">
                                <span class="phase-dot" [class.done]="modulo.inferior_hecho"
                                    [class.assigned]="!modulo.inferior_hecho && isPhaseAssigned(modulo, 'INFERIOR')"
                                    title="Inferior"></span>
                                <span class="phase-dot" [class.done]="modulo.superior_hecho"
                                    [class.assigned]="!modulo.superior_hecho && isPhaseAssigned(modulo, 'SUPERIOR')"
                                    title="Superior"></span>
                            </div>
                        </div>
                    </li>

                    <!-- NESTED SUBFASES LIST (visible when selected) -->
                    @if (selectedModulo?.id === modulo.id) {
                    <div class="sidebar-module-images">
                        @if (loadingImagenes) {
                        <div class="sidebar-loading">Cargando...</div>
                        } @else if (activeSubfases.length === 0) {
                        <div class="sidebar-empty">Sin fases disponibles</div>
                        } @else {
                        @for (subfase of activeSubfases; track subfase.id) {
                        <div class="sidebar-image-item" [attr.draggable]="!subfase.hecho && !subfase.assigned"
                            (dragstart)="onSubfaseDragStart($event, subfase)" (dragend)="onDragEnd($event)"
                            [class.assigned]="subfase.assigned" [class.hecho]="subfase.hecho"
                            [style.opacity]="(subfase.assigned || subfase.hecho) ? '0.6' : '1'">

                            <span class="sidebar-img-icon" [class.inferior]="subfase.fase === 'INFERIOR'"
                                [class.superior]="subfase.fase === 'SUPERIOR'">{{ subfase.fase === 'INFERIOR' ? '‚ñº' :
                                '‚ñ≤'
                                }}</span>
                            <div class="sidebar-img-info">
                                <span class="sidebar-img-name">{{ subfase.modulo.nombre }}</span>
                                <span class="sidebar-img-type">{{ subfase.fase }} ({{ subfase.imagenes.length }}
                                    imgs)</span>
                                @if (getSubfaseStatusText(subfase)) {
                                <span class="sidebar-img-assigment">{{ getSubfaseStatusText(subfase) }}</span>
                                }
                            </div>
                            <span class="drag-handle" *ngIf="!subfase.assigned && !subfase.hecho">‚ãÆ‚ãÆ</span>

                            <!-- Status Badge -->
                            @if (subfase.assigned || subfase.hecho) {
                            <span class="sidebar-status-badge" [class.hecho]="subfase.hecho">
                                {{ subfase.hecho ? '‚úì' : '‚ü≥' }}
                            </span>
                            }
                        </div>
                        }
                        }
                    </div>
                    }
                    }
                </ul>
                }
            </div>
        </aside>

        <!-- WORKSPACE: IMAGES & MESAS -->
        <section class="dashboard-workspace">

            <!-- SOURCE ZONE: IMAGES PANEL (Visible when a module is selected) -->
            <!-- SOURCE ZONE: MOVED TO SIDEBAR -->
            <!-- Dashboard Workspace now only shows Mesas -->



            <!-- TARGET ZONE: MESAS GRID -->
            <div class="mesas-section">
                <div class="section-header">
                    <h2>Mesas de Trabajo</h2>
                </div>
                <div class="mesas-grid" cdkDropListGroup>
                    @if (loadingMesas) {
                    <div class="loading">Cargando mesas...</div>
                    } @else {
                    @for (mesa of mesas; track trackByMesa($index, mesa)) {
                    <div class="mesa-card" [class.locked]="mesa.locked" [class.blackout]="mesa.blackout"
                        (dragover)="onDragOver($event, mesa)" (dragleave)="onDragLeave($event)"
                        (drop)="onSubfaseDrop($event, mesa)" [class.drag-over]="dragOverMesa === mesa.id">
                        <div class="mesa-header">
                            <div class="mesa-title-container">
                                @if (editingMesaId === mesa.id) {
                                <input type="text" [(ngModel)]="editingMesaName" (blur)="updateMesaName(mesa)"
                                    (keyup.enter)="updateMesaName(mesa)" (keyup.escape)="stopEditingMesa()"
                                    class="mesa-name-input" autofocus onclick="this.select()">
                                } @else {
                                <h3 (click)="startEditingMesa(mesa)" title="Click para renombrar">{{ mesa.nombre }}
                                    <span class="edit-icon">‚úé</span>
                                </h3>
                                }
                            </div>
                            <div class="mesa-header-actions">
                                @if (mesa.locked) { <span class="mesa-badge locked">üîí</span> }
                                @if (mesa.blackout) { <span class="mesa-badge blackout">‚¨õ</span> }

                                <!-- Link Status (Moved to Header) -->
                                <!-- Link Status -->
                                <div class="header-link-status">
                                    @if (mesa.is_linked) {
                                    <button class="btn-view-projection-sm linked" (click)="openProjectionView(mesa)"
                                        title="Proyecci√≥n Conectada (Ver Visor)">
                                        üñ•Ô∏è
                                    </button>
                                    } @else {
                                    <button class="btn-view-projection-sm unlinked" (click)="openProjectionView(mesa)"
                                        title="Sin vincular (Abrir para vincular)">
                                        üîå
                                    </button>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Queue -->
                        <div class="mesa-queue" cdkDropList [cdkDropListData]="getMesaQueueItems(mesa.id)"
                            (cdkDropListDropped)="onMesaQueueDrop($event, mesa.id)">
                            @for (item of getMesaQueueItems(mesa.id); track trackByItem($index, item)) {
                            <div class="queue-item" [class]="getItemStatusClass(item.status)"
                                [cdkDragDisabled]="item.status === 'MOSTRANDO'" cdkDrag>
                                <div class="drag-handle" [class.invisible]="item.status === 'MOSTRANDO'" cdkDragHandle
                                    title="Arrastrar para reordenar">‚ãÆ‚ãÆ</div>
                                <div class="queue-item-info">
                                    <span class="queue-item-fase" [class.inferior]="item.fase === 'INFERIOR'"
                                        [class.superior]="item.fase === 'SUPERIOR'">
                                        {{ item.fase === 'INFERIOR' ? '‚ñº' : '‚ñ≤' }}
                                    </span>
                                    <!-- Click to navigate -->
                                    <span class="queue-item-nombre clickable" (click)="navigateToModule(item)"
                                        title="Ver en Proyectos">
                                        {{ item.modulo_nombre }}
                                        <span class="link-icon">‚Üó</span>
                                    </span>
                                    <span class="queue-item-status">{{ item.status }}</span>
                                </div>
                                <div class="queue-item-actions">
                                    <!-- Play button removed (auto-project) -->
                                    <!-- Play/Finish button removed (auto-project via polling) -->
                                    @if (item.status !== 'HECHO') {
                                    <button class="btn-action btn-eliminar" (click)="eliminarItem(item)"
                                        title="Eliminar">‚úï</button>
                                    }
                                </div>
                            </div>
                            }
                        </div>
                    </div>
                    }
                    }
                </div>
            </div>

        </section>
    </main>
</div>

<!-- Custom Confirm Modal -->
@if (showConfirmModal) {
<div class="modal-overlay" (click)="cerrarConfirmModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-icon">‚ö†Ô∏è</div>
        <p class="modal-message">{{ confirmModalMessage }}</p>
        <div class="modal-actions">
            <button class="btn-modal btn-cancel" (click)="cerrarConfirmModal()">Cancelar</button>
            <button class="btn-modal btn-confirm" (click)="confirmarAccion()">
                {{ pendingActionType === 'DELETE' ? 'Eliminar' : 'Confirmar' }}
            </button>
        </div>
    </div>
</div>
}

<!-- Blueprint Modal -->
@if (showBlueprintModal) {
<div class="modal-overlay blueprint-overlay" (click)="cerrarBlueprintModal()">
    <div class="blueprint-modal-content" (click)="$event.stopPropagation()">
        <div class="blueprint-header">
            <h3>Plano - {{ selectedPlanta?.nombre }}</h3>
            <button class="btn-close" (click)="cerrarBlueprintModal()">√ó</button>
        </div>
        <div class="blueprint-body">
            <img [src]="blueprintUrl" alt="Plano de Planta">
        </div>
    </div>
</div>
}