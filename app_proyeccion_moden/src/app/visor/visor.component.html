<div class="visor-container" [class.blackout]="mesaState?.blackout">

    <!-- LOADING STATE -->
    @if (mode === 'LOADING') {
    <div class="loading-screen">
        <div class="spinner"></div>
        <p>Conectando...</p>
    </div>
    }

    <!-- PAIRING MODE -->
    @if (mode === 'PAIRING') {
    <div class="pairing-screen">
        <p class="pairing-label">CÓDIGO DE VINCULACIÓN</p>
        <p class="pairing-code">{{ pairingCode }}</p>
        <p class="pairing-hint">Introduce este código en el Dashboard para vincular esta mesa.</p>
    </div>
    }

    <!-- ERROR STATE -->
    @if (mode === 'ERROR') {
    <div class="error-screen">
        <p class="error-title">Error</p>
        <p class="error-message">{{ errorMessage }}</p>
        <button (click)="requestPairingCode()">Reintentar</button>
    </div>
    }

    <!-- PROJECTION MODE -->
    @if (mode === 'PROJECTION') {
    <div class="projection-screen">
        <app-mapper [imageUrl]="(images.length > 0 ? images[currentIndex].url : null) ?? mesaState?.image_url"
            [isCalibrationActive]="isSupervisor && ((!images.length && !mesaState?.image_url) || mesaState?.mapper_enabled)"
            [mesaId]="mesaState?.id ?? null" [calibrationJson]="mesaState?.calibration_json ?? null"
            [allowInteraction]="isSupervisor">
        </app-mapper>

        <!-- Active Item Info Overlay -->
        @if (activeItem && images.length > 0) {
        <div class="active-item-info">
            <span class="info-title">{{ activeItem.modulo_nombre }} - {{ activeItem.fase }}</span>
            <span class="info-progress">{{ currentIndex + 1 }} / {{ images.length }}</span>
        </div>
        }

        <!-- Mesa Watermark for debugging -->
        <div class="mesa-watermark">
            {{ mesaState?.nombre || 'Mesa ID: ' + mesaState?.id }}
        </div>
    </div>
    }

</div>